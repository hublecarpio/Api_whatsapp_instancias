OBJETIVO

Convertir tu backend actual de WhatsApp multi-instancias , donde el usuario:

Se registra

Crea su empresa

Conecta su WhatsApp mediante tu backend existente

Carga productos, políticas, fotos

Configura su prompt maestro (agente IA del negocio)

Puede chatear desde un panel web

Puede activar/desactivar el bot IA

Puede usar su propio token de OpenAI con 4.1-mini

===========================
1. ARQUITECTURA FINAL
===========================
BACKEND

Stack:

Node.js + Express

TypeScript

Prisma ORM

PostgreSQL

OpenAI API

LangChain + LangGraph (opcional pero recomendado)

MinIO (ya existe)

Tu backend actual de WhatsApp BAILEYS como microservicio

Servicios separados:

Core API (usuarios, empresas, productos, agent IA, chat panel)

WhatsApp API (tu backend ya construido)

Servicio de IA (puede estar dentro del core o separado)

FRONTEND

Next.js 14 (App Router)

React + TailwindCSS

Zustand o Context para estados

axios para llamadas

INFRAESTRUCTURA

Docker Swarm

Traefik (TLS + routing)

MinIO (media)

PostgreSQL

S3 presigned URLs

===============================
2. BASE DE DATOS COMPLETA (PRISMA)
===============================

CÓPIA Y PEGA ESTO EN schema.prisma:

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id              String     @id @default(uuid())
  name            String
  email           String      @unique
  passwordHash    String
  createdAt       DateTime    @default(now())
  businesses      Business[]
}

model Business {
  id               String     @id @default(uuid())
  userId           String
  name             String
  description      String?
  industry         String?
  openaiApiKey     String?
  openaiModel      String?    @default("gpt-4.1-mini")
  botEnabled       Boolean    @default(true)
  createdAt        DateTime   @default(now())

  user             User        @relation(fields: [userId], references: [id])
  instances        WhatsAppInstance[]
  products         Product[]
  policies         Policy?
  promptMaster     AgentPrompt?
  messages         MessageLog[]
}

model WhatsAppInstance {
  id                 String   @id @default(uuid())
  businessId         String
  instanceBackendId  String
  status             String   // open | closed | pending_qr
  qr                 String?
  lastConnection     DateTime?
  createdAt          DateTime @default(now())

  business           Business @relation(fields: [businessId], references: [id])
}

model Product {
  id          String   @id @default(uuid())
  businessId  String
  title       String
  description String?
  price       Float
  imageUrl    String?
  createdAt   DateTime @default(now())

  business    Business @relation(fields: [businessId], references: [id])
}

model Policy {
  id               String @id @default(uuid())
  businessId       String
  shippingPolicy   String?
  refundPolicy     String?
  brandVoice       String?
  allowedHours     String?

  business         Business @relation(fields: [businessId], references: [id])
}

model AgentPrompt {
  id           String   @id @default(uuid())
  businessId   String
  prompt       String
  updatedAt    DateTime @default(now())

  business     Business @relation(fields: [businessId], references: [id])
}

model MessageLog {
  id             String    @id @default(uuid())
  businessId     String
  instanceId     String?
  direction      String    // inbound | outbound
  sender         String?
  recipient      String?
  message        String?
  mediaUrl       String?
  createdAt      DateTime  @default(now())

  business       Business  @relation(fields: [businessId], references: [id])
}

==================================
3. ENDPOINTS BACKEND — DEFINITIVOS
==================================
AUTH
POST /auth/register
POST /auth/login
GET  /auth/me

BUSINESS
POST /business
GET  /business
PUT  /business/:id
PUT  /business/:id/openai  // configurar token y modelo
PUT  /business/:id/bot-toggle // activar/desactivar IA

PRODUCTS
POST /products
GET  /products?business_id=...
PUT  /products/:id
DELETE /products/:id

POLICIES
POST /policies
PUT  /policies/:id
GET  /policies?business_id=...

PROMPT
POST /agent/prompt
PUT  /agent/prompt/:id
GET  /agent/prompt?business_id=...

INSTANCIAS WHATSAPP
POST /wa/create
GET  /wa/:business_id/status
GET  /wa/:business_id/qr
POST /wa/:business_id/send

IA PROCESSING

Este es el endpoint principal de tu agente IA:

POST /agent/think
Body:
{
  business_id: "...",
  user_message: "...",
  phone: "..."
}


Backend hace:

Carga openaiApiKey del business

Carga prompt

Carga productos / políticas

Construye contexto

Llama a OpenAI 4.1-mini

Decide:

Enviar mensaje

Solicitar info

Usar herramientas

Guarda log

=============================
4. LÓGICA DEL AGENTE IA
=============================
Flujo del webhook:
WhatsApp → webhook → Core API: /agent/think → IA → sendMessage → cliente

Casos:
Si botEnabled = TRUE:

→ IA responde automáticamente
→ Envía por WhatsApp
→ Guarda logs

Si botEnabled = FALSE:

→ NO IA
→ Solo registrar logs
→ Cliente aparece en panel web
→ Usuario responde manualmente

=================================================
5. INTERFAZ VISUAL — TODO LO QUE DEBE IMPLEMENTAR
=================================================
1. Login / Registro

Correo / contraseña

JWT storage local

Ruta protegida: /dashboard

2. Onboarding de empresa

Formulario:

nombre

industria

descripción

políticas

token OpenAI

modelo IA: gpt-4.1-mini

subir logo opcional

3. Conectar WhatsApp

Pantalla:

Botón “Crear instancia”

Mostrar QR cuando status === pending_qr

Mostrar conectado cuando open

4. Panel del agente IA

Editor del prompt maestro

Botón “Guardar Prompt”

Botón “Apagar IA / Encender IA”

5. Catálogo de productos

CRUD completo:

Imagen → upload S3 (MinIO)

Título

Precio

Descripción

6. Panel de chat

Tipo Chatwoot:

Lista de conversaciones

Historial

Mensajes inbound/outbound

Campo para enviar mensaje manual

Indicar si bot está encendido o apagado

=====================================
6. TECNOLOGÍAS EXACTAS A UTILIZAR
=====================================
BACKEND
npm install express cors bcrypt jsonwebtoken
npm install prisma @prisma/client
npm install openai
npm install langchain @langchain/core langchain-openai
npm install multer uuid

FRONTEND
npm install next react tailwindcss axios zustand

IA

OpenAI API (modelo por defecto: gpt-4.1-mini)

Capacidad de tools/function calling

===================================
7. ORDEN EXACTO QUE REPLIT DEBE SEGUIR
===================================
PASO 1 — Preparar entorno

Instalar dependencias backend

Crear schema.prisma

Ejecutar:

npx prisma migrate dev

PASO 2 — Crear AUTH

register

login

middleware JWT

PASO 3 — CRUD de empresa

Incluyendo token de OpenAI.

PASO 4 — Integrar base con WhatsApp API existente

Crear instancia

Guardar ID backend

Mostrar QR desde el backend WA

PASO 5 — Crear endpoint /agent/think

Construcción del contexto

Llamada a IA

Manejo de errores

Envío a WhatsApp

PASO 6 — Panel de chat

Socket.io o polling

Listar conversaciones

PASO 7 — CRUD productos

MinIO upload

Prisma integration

PASO 8 — Prompt maestro

Editor

Guardar con versioning

PASO 9 — Modo bot enabled/disabled

Endpoint

Botón UI

PASO 10 — Deploy on Docker Swarm + Traefik

Core API

Frontend

WhatsApp backend

===========================
8. CHECKLIST FINAL
===========================
Backend

[ ] Auth
[ ] Users
[ ] Business + OpenAI token
[ ] WhatsApp instance binding
[ ] Product CRUD
[ ] Policy CRUD
[ ] Prompt CRUD
[ ] IA Pipeline
[ ] Logs
[ ] Bot enable/disable
[ ] Media upload MinIO

Frontend

[ ] Login/Registro
[ ] Dashboard
[ ] Onboarding empresa
[ ] Conexión WhatsApp + QR
[ ] Panel chat
[ ] Productos
[ ] Prompt editor
[ ] Configuración IA
[ ] Bot toggle

Infra

[ ] Traefik routing
[ ] Swarm deployment
[ ] HTTPS
[ ] Postgres backups
[ ] MinIO persistent volumes