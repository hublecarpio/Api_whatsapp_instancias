datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum UserRole {
  ADMIN
  ASESOR
}

model User {
  id                          String              @id @default(uuid())
  name                        String
  email                       String              @unique
  passwordHash                String
  role                        UserRole            @default(ADMIN)
  parentUserId                String?
  emailVerified               Boolean             @default(false)
  verificationToken           String?
  verificationTokenExpiresAt  DateTime?
  lastVerificationSentAt      DateTime?
  passwordResetToken          String?
  passwordResetExpiresAt      DateTime?
  lastPasswordResetSentAt     DateTime?
  stripeCustomerId            String?
  stripeSubscriptionId        String?
  subscriptionStatus          SubscriptionStatus  @default(PENDING)
  trialEndAt                  DateTime?
  isPro                       Boolean             @default(false)
  paymentLinkEnabled          Boolean             @default(false)
  proBonusExpiresAt           DateTime?
  referralCode                String?
  createdAt                   DateTime            @default(now())
  businesses                  Business[]
  subscriptions               Subscription[]
  parentUser                  User?               @relation("UserAdvisors", fields: [parentUserId], references: [id])
  advisors                    User[]              @relation("UserAdvisors")
  advisorInvitations          AdvisorInvitation[] @relation("InvitedBy")
  contactAssignments          ContactAssignment[]
}

model AdvisorInvitation {
  id            String    @id @default(uuid())
  email         String
  token         String    @unique
  invitedById   String
  businessId    String
  expiresAt     DateTime
  acceptedAt    DateTime?
  createdAt     DateTime  @default(now())
  
  invitedBy     User      @relation("InvitedBy", fields: [invitedById], references: [id], onDelete: Cascade)
  business      Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  @@unique([email, businessId])
}

model ContactAssignment {
  id           String   @id @default(uuid())
  businessId   String
  contactPhone String
  userId       String
  assignedAt   DateTime @default(now())
  
  business     Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([businessId, contactPhone])
}

enum ReferralCodeType {
  STANDARD
  ENTERPRISE
}

enum SubscriptionTier {
  STANDARD
  PRO
  ENTERPRISE
}

enum SubscriptionSource {
  STRIPE
  ENTERPRISE
  TRIAL
}

model ReferralCode {
  id                String            @id @default(uuid())
  code              String            @unique
  description       String?
  type              ReferralCodeType  @default(STANDARD)
  grantTier         SubscriptionTier?
  grantDurationDays Int?
  maxUses           Int?
  isActive          Boolean           @default(true)
  usageCount        Int               @default(0)
  createdAt         DateTime          @default(now())
  expiresAt         DateTime?

  subscriptions     Subscription[]

  @@index([code])
  @@index([type, isActive])
}

model Subscription {
  id              String             @id @default(uuid())
  userId          String
  source          SubscriptionSource
  tier            SubscriptionTier   @default(PRO)
  status          SubscriptionStatus @default(ACTIVE)
  startsAt        DateTime           @default(now())
  endsAt          DateTime?
  referralCodeId  String?
  activatedBy     String?
  notes           String?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  user            User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  referralCode    ReferralCode?      @relation(fields: [referralCodeId], references: [id], onDelete: SetNull)

  @@index([userId, status])
  @@index([endsAt, status])
  @@index([source])
}

enum SystemEventType {
  USER_REGISTERED
  USER_LOGIN
  USER_LOGOUT
  BUSINESS_CREATED
  BUSINESS_UPDATED
  INSTANCE_CREATED
  INSTANCE_CONNECTED
  INSTANCE_DISCONNECTED
  INSTANCE_ERROR
  MESSAGE_SENT
  MESSAGE_RECEIVED
  AI_RESPONSE
  AI_ERROR
  ORDER_CREATED
  ORDER_PAID
  ORDER_SHIPPED
  ORDER_DELIVERED
  PAYMENT_SUCCESS
  PAYMENT_FAILED
  SUBSCRIPTION_STARTED
  SUBSCRIPTION_CANCELLED
  TOOL_EXECUTED
  TOOL_ERROR
  WEBHOOK_RECEIVED
  API_ERROR
  SYSTEM_ERROR
  REMINDER_SENT
  APPOINTMENT_CREATED
  APPOINTMENT_CONFIRMED
}

enum EventSeverity {
  DEBUG
  INFO
  WARNING
  ERROR
  CRITICAL
}

model SystemEvent {
  id          String          @id @default(uuid())
  eventType   SystemEventType
  severity    EventSeverity   @default(INFO)
  source      String
  userId      String?
  businessId  String?
  instanceId  String?
  message     String
  details     Json?
  metadata    Json?
  ip          String?
  userAgent   String?
  duration    Int?
  createdAt   DateTime        @default(now())

  @@index([eventType, createdAt])
  @@index([severity, createdAt])
  @@index([businessId, createdAt])
  @@index([userId, createdAt])
  @@index([createdAt])
  @@index([source, createdAt])
}

enum SubscriptionStatus {
  PENDING
  TRIAL
  ACTIVE
  PAST_DUE
  CANCELED
}

enum BusinessObjective {
  SALES
  APPOINTMENTS
}

model Business {
  id                String             @id @default(uuid())
  userId            String
  name              String
  description       String?
  industry          String?
  logoUrl           String?
  openaiApiKey      String?
  openaiModel       String?            @default("gpt-4.1-mini")
  botEnabled        Boolean            @default(true)
  timezone          String             @default("America/Lima")
  agentVersion      String             @default("v1")
  agentV2Config     Json?
  currencyCode      String             @default("PEN")
  currencySymbol    String             @default("S/.")
  businessObjective BusinessObjective  @default(SALES)
  appointmentConfig Json?
  businessContext   Json?
  injectionCode     String?
  apiKeyHash        String?
  apiKeyPrefix      String?
  apiKeyCreatedAt   DateTime?
  webhookUrl        String?
  webhookEvents     String[]           @default([])
  webhookSecret     String?
  roundRobinEnabled Boolean            @default(false)
  roundRobinAdvisors String[]          @default([])
  roundRobinLastIndex Int              @default(0)
  createdAt         DateTime           @default(now())

  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  instances         WhatsAppInstance[]
  products          Product[]
  policy            Policy?
  promptMaster      AgentPrompt?
  messages          MessageLog[]
  tags              Tag[]
  followUpConfig    FollowUpConfig?
  reminders         Reminder[]
  appointments      Appointment[]
  availability      BusinessAvailability[]
  advisorInvitations AdvisorInvitation[]
  contactAssignments ContactAssignment[]
}

enum WhatsAppProvider {
  BAILEYS
  META_CLOUD
}

model WhatsAppInstance {
  id                String           @id @default(uuid())
  businessId        String
  name              String           @default("WhatsApp")
  provider          WhatsAppProvider @default(BAILEYS)
  instanceBackendId String?
  phoneNumber       String?
  status            String           @default("pending_qr")
  qr                String?
  isActive          Boolean          @default(true)
  lastConnection    DateTime?
  createdAt         DateTime         @default(now())

  business       Business                 @relation(fields: [businessId], references: [id], onDelete: Cascade)
  metaCredential MetaCredential?
  history        WhatsAppInstanceHistory[]
}

enum InstanceEventType {
  CREATED
  CONNECTED
  DISCONNECTED
  PROVIDER_CHANGED
  DELETED
  RECONNECTED
  QR_GENERATED
  SESSION_EXPIRED
  ERROR
}

model WhatsAppInstanceHistory {
  id              String            @id @default(uuid())
  instanceId      String?
  businessId      String
  eventType       InstanceEventType
  previousProvider WhatsAppProvider?
  newProvider     WhatsAppProvider?
  previousStatus  String?
  newStatus       String?
  phoneNumber     String?
  backendId       String?
  details         String?
  metadata        Json?
  createdAt       DateTime          @default(now())

  instance WhatsAppInstance? @relation(fields: [instanceId], references: [id], onDelete: SetNull)

  @@index([businessId, createdAt])
  @@index([instanceId, createdAt])
}

model MetaCredential {
  id                 String   @id @default(uuid())
  instanceId         String   @unique
  accessToken        String
  businessId         String
  phoneNumberId      String
  appId              String
  appSecret          String
  webhookVerifyToken String   @default(uuid())
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  instance  WhatsAppInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  templates MetaTemplate[]
}

model MetaTemplate {
  id             String   @id @default(uuid())
  credentialId   String
  metaTemplateId String
  name           String
  language       String   @default("es")
  category       String   @default("UTILITY")
  status         String   @default("PENDING")
  components     Json
  headerType     String?
  bodyText       String?
  footerText     String?
  buttons        Json?
  lastSynced     DateTime @default(now())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  credential MetaCredential @relation(fields: [credentialId], references: [id], onDelete: Cascade)

  @@unique([credentialId, name])
  @@index([credentialId, status])
}

model Product {
  id          String   @id @default(uuid())
  businessId  String
  title       String
  description String?
  price       Float
  stock       Int      @default(0)
  imageUrl    String?
  createdAt   DateTime @default(now())

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId, title])
}

model Policy {
  id             String  @id @default(uuid())
  businessId     String  @unique
  shippingPolicy String?
  refundPolicy   String?
  brandVoice     String?
  allowedHours   String?

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
}

model AgentPrompt {
  id            String   @id @default(uuid())
  businessId    String   @unique
  prompt        String
  bufferSeconds Int      @default(0)
  historyLimit  Int      @default(10)
  splitMessages Boolean  @default(true)
  updatedAt     DateTime @default(now())

  business Business    @relation(fields: [businessId], references: [id], onDelete: Cascade)
  tools    AgentTool[]
  files    AgentFile[]
}

model AgentFile {
  id          String   @id @default(uuid())
  promptId    String
  name        String
  description String?
  fileUrl     String
  fileType    String   @default("document")
  triggerKeywords String?
  triggerContext  String?
  order       Int      @default(0)
  enabled     Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  prompt AgentPrompt @relation(fields: [promptId], references: [id], onDelete: Cascade)

  @@index([promptId, enabled])
  @@index([promptId, order])
}

model AgentTool {
  id          String  @id @default(uuid())
  promptId    String
  name        String
  description String
  url         String
  method      String  @default("POST")
  headers     Json?
  bodyTemplate Json?
  parameters  Json?
  enabled     Boolean @default(true)

  prompt AgentPrompt @relation(fields: [promptId], references: [id], onDelete: Cascade)
  logs   ToolLog[]
}

model ToolLog {
  id          String   @id @default(uuid())
  toolId      String
  businessId  String
  contactPhone String?
  request     Json
  response    Json?
  status      String   @default("success")
  duration    Int?
  createdAt   DateTime @default(now())

  tool AgentTool @relation(fields: [toolId], references: [id], onDelete: Cascade)
}

model MessageBuffer {
  id              String    @id @default(uuid())
  businessId      String
  contactPhone    String
  messages        Json
  createdAt       DateTime  @default(now())
  expiresAt       DateTime
  processingUntil DateTime?
  retryCount      Int       @default(0)
  failedAt        DateTime?
  failureReason   String?

  @@unique([businessId, contactPhone])
  @@index([expiresAt, processingUntil])
  @@index([failedAt])
}

model MessageLog {
  id                String   @id @default(uuid())
  businessId        String
  instanceId        String?
  providerMessageId String?
  direction         String
  sender            String?
  recipient         String?
  message           String?
  mediaUrl          String?
  metadata          Json?
  createdAt         DateTime @default(now())

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@unique([businessId, providerMessageId])
}

model Tag {
  id          String   @id @default(uuid())
  businessId  String
  name        String
  color       String   @default("#6B7280")
  description String?
  order       Int      @default(0)
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  business     Business        @relation(fields: [businessId], references: [id], onDelete: Cascade)
  assignments  TagAssignment[]
  history      TagHistory[]
  stagePrompt  StagePrompt?

  @@unique([businessId, name])
  @@index([businessId, order])
}

model TagAssignment {
  id           String   @id @default(uuid())
  tagId        String
  businessId   String
  contactPhone String
  assignedAt   DateTime @default(now())
  assignedBy   String?
  source       String   @default("manual")

  tag Tag @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([businessId, contactPhone])
  @@index([businessId, tagId])
  @@index([tagId])
}

model TagHistory {
  id           String    @id @default(uuid())
  tagId        String
  businessId   String
  contactPhone String
  assignedAt   DateTime  @default(now())
  removedAt    DateTime?
  source       String    @default("manual")
  notes        String?

  tag Tag @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@index([businessId, contactPhone])
  @@index([tagId, assignedAt])
}

model StagePrompt {
  id              String  @id @default(uuid())
  tagId           String  @unique
  promptOverride  String?
  systemContext   String?
  toolsOverride   Json?

  tag Tag @relation(fields: [tagId], references: [id], onDelete: Cascade)
}

model FollowUpConfig {
  id                  String   @id @default(uuid())
  businessId          String   @unique
  enabled             Boolean  @default(true)
  firstDelayMinutes   Int      @default(15)
  secondDelayMinutes  Int      @default(60)
  thirdDelayMinutes   Int      @default(240)
  maxDailyAttempts    Int      @default(3)
  pressureLevel       Int      @default(1)
  allowedStartHour    Int      @default(9)
  allowedEndHour      Int      @default(21)
  weekendsEnabled     Boolean  @default(false)
  triggerMode         String   @default("user")
  stopOnReply         Boolean  @default(true)
  followUpSteps       Json?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  business  Business   @relation(fields: [businessId], references: [id], onDelete: Cascade)
  reminders Reminder[]
}

model Reminder {
  id              String    @id @default(uuid())
  businessId      String
  contactPhone    String
  contactName     String?
  scheduledAt     DateTime
  executedAt      DateTime?
  type            String    @default("auto")
  status          String    @default("pending")
  attemptNumber   Int       @default(1)
  messageTemplate String?
  generatedMessage String?
  configId        String?
  createdAt       DateTime  @default(now())
  
  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  config FollowUpConfig? @relation(fields: [configId], references: [id], onDelete: SetNull)

  @@index([businessId, status, scheduledAt])
  @@index([businessId, contactPhone])
}

model TokenUsage {
  id               String   @id @default(uuid())
  businessId       String
  userId           String?
  feature          String
  provider         String   @default("openai")
  model            String
  promptTokens     Int
  completionTokens Int
  totalTokens      Int
  costUsd          Float    @default(0)
  createdAt        DateTime @default(now())

  @@index([businessId, createdAt])
  @@index([userId, createdAt])
  @@index([createdAt])
  @@index([provider, createdAt])
}

model ContactSettings {
  id           String    @id @default(uuid())
  businessId   String
  instanceId   String?
  contactPhone String
  contactName  String?
  botDisabled  Boolean   @default(false)
  notes        String?
  archivedAt   DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([businessId, contactPhone, instanceId])
  @@index([businessId, botDisabled])
  @@index([businessId, instanceId])
  @@index([instanceId, archivedAt])
  @@index([businessId, contactPhone])
}

enum OrderStatus {
  PENDING_PAYMENT
  AWAITING_VOUCHER
  PAID
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

model Order {
  id                    String      @id @default(uuid())
  businessId            String
  contactPhone          String
  contactName           String?
  email                 String?
  shippingAddress       String?
  shippingCity          String?
  shippingState         String?
  shippingZip           String?
  shippingCountry       String?
  notes                 String?
  totalAmount           Float
  currencyCode          String      @default("PEN")
  currencySymbol        String      @default("S/.")
  status                OrderStatus @default(PENDING_PAYMENT)
  stripeSessionId       String?     @unique
  stripePaymentIntentId String?
  paidAt                DateTime?
  voucherImageUrl       String?
  voucherReceivedAt     DateTime?
  deliveryAgentName     String?
  deliveryAgentPhone    String?
  deliveryNotes         String?
  deliveredAt           DateTime?
  preparationStartedAt  DateTime?
  shippedAt             DateTime?
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt

  items OrderItem[]

  @@index([businessId, status])
  @@index([businessId, contactPhone])
  @@index([createdAt])
}

model OrderItem {
  id           String  @id @default(uuid())
  orderId      String
  productId    String?
  productTitle String
  quantity     Int     @default(1)
  unitPrice    Float
  imageUrl     String?

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
}

model PaymentSession {
  id              String   @id @default(uuid())
  businessId      String
  contactPhone    String
  productIds      Json
  quantities      Json
  totalAmount     Float
  currencyCode    String
  shortCode       String   @unique
  stripeSessionId String   @unique
  paymentUrl      String
  status          String   @default("pending")
  metadata        Json?
  expiresAt       DateTime
  createdAt       DateTime @default(now())

  @@index([businessId, contactPhone])
  @@index([stripeSessionId])
  @@index([shortCode])
  @@index([status, expiresAt])
}

model ExtractionField {
  id           String   @id @default(uuid())
  businessId   String
  fieldKey     String
  fieldLabel   String
  fieldType    String   @default("text")
  required     Boolean  @default(false)
  order        Int      @default(0)
  enabled      Boolean  @default(true)
  createdAt    DateTime @default(now())

  @@unique([businessId, fieldKey])
  @@index([businessId])
}

model ContactExtractedData {
  id           String   @id @default(uuid())
  businessId   String
  contactPhone String
  fieldKey     String
  fieldValue   String?
  extractedAt  DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([businessId, contactPhone, fieldKey])
  @@index([businessId, contactPhone])
}

model PaymentLinkRequest {
  id               String   @id @default(uuid())
  businessId       String
  contactPhone     String?
  triggerSource    String   @default("agent")
  productId        String?
  productName      String?
  amount           Float?
  quantity         Int      @default(1)
  isSuccess        Boolean  @default(false)
  failureReason    String?
  orderId          String?
  paymentSessionId String?
  isPro            Boolean  @default(false)
  createdAt        DateTime @default(now())

  @@index([businessId])
  @@index([businessId, createdAt])
  @@index([isSuccess])
}

model AgentV2Config {
  id         String   @id @default(uuid())
  businessId String   @unique
  skills     Json     @default("{\"search_product\":true,\"payment\":true,\"followup\":true,\"media\":true,\"crm\":true}")
  prompts    Json     @default("{}")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([businessId])
}

model LeadMemory {
  id            String   @id @default(uuid())
  businessId    String
  leadPhone     String
  leadName      String?
  stage         String?
  preferences   Json     @default("[]")
  collectedData Json     @default("{}")
  notes         Json     @default("[]")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([businessId, leadPhone])
  @@index([businessId])
  @@index([businessId, leadPhone])
}

model LearnedRule {
  id           String   @id @default(uuid())
  businessId   String
  rule         String
  source       String   @default("refiner")
  enabled      Boolean  @default(true)
  appliedCount Int      @default(0)
  createdAt    DateTime @default(now())

  @@index([businessId])
  @@index([businessId, enabled])
}

enum KnowledgeDocType {
  TEXT
  FAQ
  POLICY
  GUIDE
  OTHER
}

model KnowledgeDocument {
  id         String           @id @default(uuid())
  businessId String
  title      String
  content    String
  type       KnowledgeDocType @default(TEXT)
  embedding  Json?
  chunks     Json?
  metadata   Json?
  enabled    Boolean          @default(true)
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt

  @@index([businessId])
  @@index([businessId, enabled])
  @@index([businessId, type])
}

enum AppointmentStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
  NO_SHOW
}

model Appointment {
  id                 String            @id @default(uuid())
  businessId         String
  contactPhone       String
  contactName        String?
  scheduledAt        DateTime
  durationMinutes    Int               @default(60)
  status             AppointmentStatus @default(PENDING)
  service            String?
  notes              String?
  reminderSentAt     DateTime?
  confirmedAt        DateTime?
  cancelledAt        DateTime?
  completedAt        DateTime?
  cancellationReason String?
  createdBy          String            @default("agent")
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId, scheduledAt])
  @@index([businessId, status])
  @@index([businessId, contactPhone])
  @@index([scheduledAt])
}

model BusinessAvailability {
  id          String   @id @default(uuid())
  businessId  String
  dayOfWeek   Int
  startTime   String
  endTime     String
  isBlocked   Boolean  @default(false)
  blockDate   DateTime?
  blockReason String?
  createdAt   DateTime @default(now())

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId, dayOfWeek])
  @@index([businessId, blockDate])
}
