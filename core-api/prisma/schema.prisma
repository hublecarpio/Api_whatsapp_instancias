datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id                          String              @id @default(uuid())
  name                        String
  email                       String              @unique
  passwordHash                String
  emailVerified               Boolean             @default(false)
  verificationToken           String?
  verificationTokenExpiresAt  DateTime?
  lastVerificationSentAt      DateTime?
  stripeCustomerId            String?
  stripeSubscriptionId        String?
  subscriptionStatus          SubscriptionStatus  @default(PENDING)
  trialEndAt                  DateTime?
  isPro                       Boolean             @default(false)
  createdAt                   DateTime            @default(now())
  businesses                  Business[]
}

enum SubscriptionStatus {
  PENDING
  TRIAL
  ACTIVE
  PAST_DUE
  CANCELED
}

model Business {
  id            String             @id @default(uuid())
  userId        String
  name          String
  description   String?
  industry      String?
  logoUrl       String?
  openaiApiKey  String?
  openaiModel   String?            @default("gpt-4.1-mini")
  botEnabled    Boolean            @default(true)
  timezone      String             @default("America/Lima")
  agentVersion  String             @default("v1")
  agentV2Config Json?
  createdAt     DateTime           @default(now())

  user           User               @relation(fields: [userId], references: [id])
  instances      WhatsAppInstance[]
  products       Product[]
  policy         Policy?
  promptMaster   AgentPrompt?
  messages       MessageLog[]
  tags           Tag[]
  followUpConfig FollowUpConfig?
  reminders      Reminder[]
}

enum WhatsAppProvider {
  BAILEYS
  META_CLOUD
}

model WhatsAppInstance {
  id                String           @id @default(uuid())
  businessId        String
  name              String           @default("WhatsApp")
  provider          WhatsAppProvider @default(BAILEYS)
  instanceBackendId String?
  phoneNumber       String?
  status            String           @default("pending_qr")
  qr                String?
  isActive          Boolean          @default(true)
  lastConnection    DateTime?
  createdAt         DateTime         @default(now())

  business       Business        @relation(fields: [businessId], references: [id], onDelete: Cascade)
  metaCredential MetaCredential?
}

model MetaCredential {
  id                 String   @id @default(uuid())
  instanceId         String   @unique
  accessToken        String
  businessId         String
  phoneNumberId      String
  appId              String
  appSecret          String
  webhookVerifyToken String   @default(uuid())
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  instance  WhatsAppInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  templates MetaTemplate[]
}

model MetaTemplate {
  id             String   @id @default(uuid())
  credentialId   String
  metaTemplateId String
  name           String
  language       String   @default("es")
  category       String   @default("UTILITY")
  status         String   @default("PENDING")
  components     Json
  headerType     String?
  bodyText       String?
  footerText     String?
  buttons        Json?
  lastSynced     DateTime @default(now())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  credential MetaCredential @relation(fields: [credentialId], references: [id], onDelete: Cascade)

  @@unique([credentialId, name])
  @@index([credentialId, status])
}

model Product {
  id          String   @id @default(uuid())
  businessId  String
  title       String
  description String?
  price       Float
  imageUrl    String?
  createdAt   DateTime @default(now())

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
}

model Policy {
  id             String  @id @default(uuid())
  businessId     String  @unique
  shippingPolicy String?
  refundPolicy   String?
  brandVoice     String?
  allowedHours   String?

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
}

model AgentPrompt {
  id            String   @id @default(uuid())
  businessId    String   @unique
  prompt        String
  bufferSeconds Int      @default(0)
  historyLimit  Int      @default(10)
  splitMessages Boolean  @default(true)
  updatedAt     DateTime @default(now())

  business Business    @relation(fields: [businessId], references: [id], onDelete: Cascade)
  tools    AgentTool[]
}

model AgentTool {
  id          String  @id @default(uuid())
  promptId    String
  name        String
  description String
  url         String
  method      String  @default("POST")
  headers     Json?
  bodyTemplate Json?
  parameters  Json?
  enabled     Boolean @default(true)

  prompt AgentPrompt @relation(fields: [promptId], references: [id], onDelete: Cascade)
  logs   ToolLog[]
}

model ToolLog {
  id          String   @id @default(uuid())
  toolId      String
  businessId  String
  contactPhone String?
  request     Json
  response    Json?
  status      String   @default("success")
  duration    Int?
  createdAt   DateTime @default(now())

  tool AgentTool @relation(fields: [toolId], references: [id], onDelete: Cascade)
}

model MessageBuffer {
  id          String   @id @default(uuid())
  businessId  String
  contactPhone String
  messages    Json
  createdAt   DateTime @default(now())
  expiresAt   DateTime

  @@unique([businessId, contactPhone])
}

model MessageLog {
  id         String   @id @default(uuid())
  businessId String
  instanceId String?
  direction  String
  sender     String?
  recipient  String?
  message    String?
  mediaUrl   String?
  metadata   Json?
  createdAt  DateTime @default(now())

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
}

model Tag {
  id          String   @id @default(uuid())
  businessId  String
  name        String
  color       String   @default("#6B7280")
  description String?
  order       Int      @default(0)
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  business     Business        @relation(fields: [businessId], references: [id], onDelete: Cascade)
  assignments  TagAssignment[]
  history      TagHistory[]
  stagePrompt  StagePrompt?

  @@unique([businessId, name])
  @@index([businessId, order])
}

model TagAssignment {
  id           String   @id @default(uuid())
  tagId        String
  businessId   String
  contactPhone String
  assignedAt   DateTime @default(now())
  assignedBy   String?
  source       String   @default("manual")

  tag Tag @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([businessId, contactPhone])
  @@index([businessId, tagId])
  @@index([tagId])
}

model TagHistory {
  id           String    @id @default(uuid())
  tagId        String
  businessId   String
  contactPhone String
  assignedAt   DateTime  @default(now())
  removedAt    DateTime?
  source       String    @default("manual")
  notes        String?

  tag Tag @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@index([businessId, contactPhone])
  @@index([tagId, assignedAt])
}

model StagePrompt {
  id              String  @id @default(uuid())
  tagId           String  @unique
  promptOverride  String?
  systemContext   String?
  toolsOverride   Json?

  tag Tag @relation(fields: [tagId], references: [id], onDelete: Cascade)
}

model FollowUpConfig {
  id                  String   @id @default(uuid())
  businessId          String   @unique
  enabled             Boolean  @default(true)
  firstDelayMinutes   Int      @default(15)
  secondDelayMinutes  Int      @default(60)
  thirdDelayMinutes   Int      @default(240)
  maxDailyAttempts    Int      @default(3)
  pressureLevel       Int      @default(1)
  allowedStartHour    Int      @default(9)
  allowedEndHour      Int      @default(21)
  weekendsEnabled     Boolean  @default(false)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  business  Business   @relation(fields: [businessId], references: [id], onDelete: Cascade)
  reminders Reminder[]
}

model Reminder {
  id              String    @id @default(uuid())
  businessId      String
  contactPhone    String
  contactName     String?
  scheduledAt     DateTime
  executedAt      DateTime?
  type            String    @default("auto")
  status          String    @default("pending")
  attemptNumber   Int       @default(1)
  messageTemplate String?
  generatedMessage String?
  configId        String?
  createdAt       DateTime  @default(now())
  
  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  config FollowUpConfig? @relation(fields: [configId], references: [id], onDelete: SetNull)

  @@index([businessId, status, scheduledAt])
  @@index([businessId, contactPhone])
}

model TokenUsage {
  id               String   @id @default(uuid())
  businessId       String
  userId           String?
  feature          String
  model            String
  promptTokens     Int
  completionTokens Int
  totalTokens      Int
  costUsd          Float    @default(0)
  createdAt        DateTime @default(now())

  @@index([businessId, createdAt])
  @@index([userId, createdAt])
  @@index([createdAt])
}

model ContactSettings {
  id           String   @id @default(uuid())
  businessId   String
  contactPhone String
  botDisabled  Boolean  @default(false)
  notes        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([businessId, contactPhone])
  @@index([businessId, botDisabled])
}
