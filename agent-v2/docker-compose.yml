version: '3.8'

services:
  agent-v2:
    build:
      context: .
      dockerfile: Dockerfile
    image: registry.digitalocean.com/huble/agent-v2:latest
    ports:
      - "5001:5001"
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4o-mini}
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL:-redis://efficore_redis:6389}
      - CORE_API_URL=${CORE_API_URL:-http://core-api:4001}
      - PORT=5001
    networks:
      - efficore_network
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  efficore_network:
    external: true
